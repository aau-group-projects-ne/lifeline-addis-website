generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model assessment {
  id             Int       @id @default(autoincrement())
  patientId      Int
  doctorId       Int
  document       String
  estimatedPrice Float
  createdAt      DateTime  @default(now())

  doctor   user      @relation(name: "DoctorAssessments", fields: [doctorId], references: [id])
  patient  patient   @relation(name: "PatientAssessments", fields: [patientId], references: [id])
  payments payment[] @relation("AssessmentPayments")
  updates  update[]  @relation("AssessmentUpdates")

  @@index([doctorId])
  @@index([patientId])
}

model assignment {
  id         Int      @id @default(autoincrement())
  patientId  Int
  nurseId    Int
  assignedAt DateTime @default(now())

  nurse   user     @relation(name: "NurseAssignments", fields: [nurseId], references: [id])
  patient patient  @relation(name: "PatientAssignments", fields: [patientId], references: [id])

  @@index([nurseId])
  @@index([patientId])
}

model patient {
  id          Int          @id @default(autoincrement())
  userId      Int          @unique
  age         Int?
  sex         String?
  phoneNumber String?

  assessments assessment[] @relation("PatientAssessments")
  assignments assignment[] @relation("PatientAssignments")
  payments    payment[]    @relation("PatientPayments")
  ratings     rating[]     @relation("PatientRatings")

  user user @relation(name: "UserPatient", fields: [userId], references: [id])
}

model payment {
  id           Int        @id @default(autoincrement())
  patientId    Int
  assessmentId Int
  slipUrl      String
  uploadedAt   DateTime   @default(now())

  assessment assessment @relation(name: "AssessmentPayments", fields: [assessmentId], references: [id])
  patient    patient    @relation(name: "PatientPayments", fields: [patientId], references: [id])

  @@index([assessmentId])
  @@index([patientId])
}

model rating {
  id          Int      @id @default(autoincrement())
  patientId   Int
  ratedUserId Int
  score       Int
  comment     String?
  createdAt   DateTime @default(now())

  patient   patient @relation(name: "PatientRatings", fields: [patientId], references: [id])
  ratedUser user    @relation(name: "RatingsGiven", fields: [ratedUserId], references: [id])

  @@index([patientId])
  @@index([ratedUserId])
}

model update {
  id           Int        @id @default(autoincrement())
  assessmentId Int
  nurseId      Int
  statusUpdate String
  updatedAt    DateTime   @default(now())

  assessment assessment @relation(name: "AssessmentUpdates", fields: [assessmentId], references: [id])
  nurse      user       @relation(name: "NurseUpdates", fields: [nurseId], references: [id])

  @@index([assessmentId])
  @@index([nurseId])
}

model user {
  id       Int       @id @default(autoincrement())
  name     String
  email    String    @unique
  password String
  role     user_role

  doctorAssessments assessment[] @relation("DoctorAssessments")
  nurseAssignments  assignment[] @relation("NurseAssignments")
  nurseUpdates      update[]     @relation("NurseUpdates")
  ratingsGiven      rating[]     @relation("RatingsGiven")
  patient           patient?     @relation("UserPatient")
}

enum user_role {
  patient
  doctor
  nurse
  admin
}